---
title: "Video Hub 进化论：双模式部署与稳定性治理"
date: 2026-01-21
description: Video Hub 迎来架构升级，正式支持 Local 与 PikPak 双模式部署。本文复盘了从单点到双模的演进过程，以及在 Cloudflare CDN、移动端适配和稳定性治理方面的深度思考与实践。
category: development
tags: [Video Hub, 架构设计, 双模式, Cloudflare, 稳定性]
featured: true
author: weiwei
coverImage: /images/2026-01-21-dual-mode.png
readTime: 10 分钟
---

# 🚀 引言：从工具到平台

Video Hub 最初只是一个简单的文件浏览器，但随着需求的演进，它逐渐承载了更多的职责。今天，我们完成了一个重要的里程碑——**双模式部署（Dual-Mode Deployment）** 的正式落地。这不仅是功能的叠加，更是对不同使用场景（本地高性能 vs 云端灵活性）的深度解耦与适配。

---

# 🌓 第一章：双模式架构 (Dual-Mode Architecture)

为了兼顾本地极速体验与云端资源的灵活性，我们引入了 "Local" 与 "PikPak" 两种运行模式。

## 1.1 模式定义与隔离

*   **Local Mode (本地模式)**
    *   **定位**：全功能、高性能的主控端。
    *   **特性**：拥有完整的文件管理权限（上传、删除、移动），直连本地存储，响应速度极快。
    *   **场景**：家庭内网、NAS 直连。

*   **PikPak Mode (云端/代理模式)**
    *   **定位**：只读、安全的浏览端。
    *   **特性**：
        *   **安全优先**：前端自动隐藏所有写入操作入口（上传、删除）。
        *   **纯粹浏览**：专注于流媒体播放，避免误操作导致云端文件丢失。
    *   **场景**：VPS 部署、公网访问、移动端远程观看。

## 1.2 体验与交互完善

配合双模式的落地，我们在交互层面也进行了精细化打磨：

*   **状态区强化**：侧边栏增加了更醒目的状态指示，当前运行在哪个模式下一目了然。
*   **Offlint 状态处理**：在网络断开时，智能隐藏上传入口，避免用户产生“离线也能上传”的误解。

---

# 📱 第二章：移动端体验补齐

长期以来，桌面端是我们的第一优先级，但 iPad 和手机端的体验同样重要。

## 2.1 侧边栏抽屉 (Drawer)
在移动端，侧边栏不再常驻挤占屏幕，而是改为**抽屉式交互**：
*   **左上角呼出**：点击菜单按钮，侧边栏平滑滑出。
*   **遮罩关闭**：点击背景遮罩或右上角 X 即可快速收起。
*   **逻辑分离**：移动端的显隐逻辑与桌面端解耦，互不影响。

---

# 🛡️ 第三章：Cloudflare CDN 的“灰度”智慧

在追求极致播放速度的道路上，我们对 Cloudflare CDN 进行了多轮论证与测试，最终得出了一个反直觉的结论。

## 3.1 遇到的坑：大文件 Range 请求
我们最初开启了 Cloudflare 的“小黄云”（代理模式），期望通过 CDN 缓存加速视频加载。然而，现实却很骨感：
*   **现象**：播放大文件（>1GB）时频繁卡顿，甚至请求一直 Pending。
*   **原因**：CDN 节点在处理大文件 Range 请求（视频拖拽、流式播放）时，回源策略并不总是理想，容易造成回源拥塞。

## 3.2 解决方案：回归直连
经过反复测试，我们调整了策略：
1.  **Page Rules 尝试**：试图通过精细化规则（`/files/*` Bypass）来绕过缓存，但效果仍不稳定。
2.  **最终决策**：**全站灰云（DNS Only）**。
    *   放弃 CDN 的缓存能力，换取最稳定的直连链路。
    *   **经验**：对于私有视频流媒体服务，**稳定性 > 理论上的峰值速度**。直连虽然没有边缘缓存，但没有中间商赚差价（延迟），反而更流畅。

---

# 🔧 第四章：基础设施与稳定性治理

除了架构升级，我们也修复了一些影响体验的隐蔽 Bug。

## 4.1 "消失的缩略图"
*   **现象**：部署后，前端所有视频缩略图显示为空白。
*   **根因**：部署脚本逻辑漏洞。在更新 UI 时，脚本错误地覆盖了包含缩略图数据的 `index.json`，导致索引被重置为无图版本。
*   **修复**：重写 `index.json` 生成逻辑，采用**增量更新**模式，并修正部署脚本的覆盖逻辑。

## 4.2 性能优化：懒加载
随着视频数量增加，并发请求缩略图一度阻塞了视频流的加载。我们引入了**图片懒加载**机制，只有当缩略图进入视口时才发起请求，将网络带宽优先留给视频播放。

---

# 📝 结语

今天的更新，标志着 Video Hub 从一个“能用”的工具，进化为一个架构清晰、体验稳定的“平台”。

*   **双模式**解决了“要安全还是要功能”的矛盾。
*   **灰云策略**让我们在性能优化的路上学会了“退一步海阔天空”。

技术迭代不仅仅是写代码，更是不断权衡与选择的过程。做正确的事，比把事做快更重要。
