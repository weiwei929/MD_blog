---
title: "铸剑行动：Typora 交互脚本的体系化重塑"
date: 2026-01-30
description: "将 Typora 的主题脚本从好用的插件升级为可靠的战友。本次行动由 Trae 担任主攻手，完成了体检面板交互升级、AI 辅助增强与高风险操作的预算化改造。"
tags: [Tooling, Workflow, Typora, JavaScript]
coverImage: /images/2026-01-30-typora-forged-blade.png
---

# 铸剑行动：Typora 交互脚本的体系化重塑 (Operation Forged Blade)

> **日期**: 2026-01-30
> **主题**: Typora Scripting
> **状态**: 完成

> "一把好的手术刀，既要足够锋利切开病灶，又要足够精准不伤及无辜。" —— 关于写作环境的思考

---

## 1. 战役背景 (Strategic Context)

既然要追求极致的 "Flow"（心流），写作环境的每一次卡顿、每一次报错，都是对思维连贯性的“降维打击”。
今天的行动目标很明确：**将 Typora 的主题脚本（SmartChinese 3.0）从一个“好用的插件”升级为“可靠的战友”。**

特别值得记录的是，本次行动的**主攻手 (Tactical Operator)** 是 **Trae**。
作为另一个 AI 协作工具，Trae 在代码生成的细节把控上展现了惊人的“外科手术”能力。我（User）主要负责定策，而 Trae 负责在 DOM 树和 JavaScript 运行时的丛林中执行具体的“清除与加固”任务。

文件约定：`2026-02-30-Typora-Script.md` (注：元数据归档日期为 2026-01-30)
范围：`c:\Users\Admin\AppData\Roaming\Typora\themes` 下的 `cement-basic.js`（主题脚本）

---

## 2. 战术执行全回溯 (Tactical Execution)

### 0. 更新记录

- 2026-01-30 18:22:19：补充“稳/狠”两档修复预算说明与面板切换方式，并记录本次收尾时间戳。

### 1. 今日操作全回溯（按推进顺序）

#### 1.1 目标与原则
- 目标：把“体检 + 修复 + AI 辅助”做成在写作中可常驻使用的工具，既能提升质量，也不打断写作流。
- 原则：主题脚本与 Typora 共用一个运行环境，稳定性优先；任何可能卡死/崩溃的动作必须可控、可降级。

#### 1.2 交互体验：体检面板拖拽/最小化
- 给体检面板加入可拖拽能力，解决遮挡正文、位置固定带来的干扰。
- 加入最小化/还原，保持“常驻但不打扰”。

#### 1.3 AI 能力：长文本阈值提升
- 将 AI 辅助的文本长度上限提升到 20 万字级别，减少长文场景的截断与不可用。
- 保持输出策略：不道德评判、不弱化原意、不捏造事实，优先按用户指令生成。

#### 1.4 标点修复：英文直引号与混排边界
- 针对中文写作里常见的英文直引号（' "）场景，提升识别边界与替换效果，减少遗漏。
- 同时确保对链接、URL 等内容做保护，避免误改 Markdown 结构。

#### 1.5 稳定性事件：点击“尝试修复”导致 Typora 报错/闪退
- **现象**：点击“修复/尝试修复”后 Typora 弹错并自动消失（功能不一定损坏，但体验不可接受）。
- **定位**：修复入口 ThemeManager.fix(type) → fixPunctuation / fixLines 两条路径（正则替换、批量 DOM 改写）。

**处理分两步：**
- **止血**：为修复入口与修复实现加入异常隔离，避免未捕获异常直接打崩 Typora。
- **加固**：为修复动作加入并发锁、节流与预算限额，保证“单次修复可控、可中断、可重复”。

---

## 3. 战场生存法则 (Rules of Engagement)

*(即便是在脚本这样的小战场，架构思维依然适用)*

### 2.1 “脚本报错”不是普通报错，而可能是“宿主进程级后果”
- **问题**：主题脚本一旦抛出未捕获异常、或长时间阻塞主线程，Typora 可能直接退出/重启。
- **原因**：脚本与 Typora 同进程（同渲染环境），没有服务端那种天然隔离。
- **方案**：对所有高风险操作做异常隔离；对重操作做预算化（限时/限量/可降级）。

### 2.2 修复逻辑天然高风险（不确定输入 + 正则 + 批处理）
- **问题**：极端文本（超长段落、特殊符号、混排、复杂节点结构）可能触发正则灾难或 DOM 操作边界异常。
- **原因**：输入不可控，且修复通常是批量行为，风险随规模放大。
- **方案**：引入“修复预算”：
  - 并发锁：防止重复点击/重入。
  - 节流：避免短时间重复触发。
  - 单次处理节点上限：避免一次扫太多 DOM。
  - 单次时间预算：超时即退出，防卡死。
  - 单段文本上限：超长段直接跳过，保稳定。

### 2.3 “一次修完”不是最优目标，“稳定可重复”才是
- **问题**：追求一次性把全部问题修完，容易把风险堆到单次操作里。
- **原因**：主题脚本缺乏完整的隔离、回滚、重试体系；崩溃成本远大于多点几次。
- **方案**：把修复做成幂等、可重复触发；允许多次点击逐步完成。

---

## 4. 战果与装备升级 (Debriefing & Gear Up)

### 3.1 成果清单
- **体检面板 (Monitor)**：可拖拽、可最小化，写作干扰显著降低。
- **AI 辅助 (Intelligence)**：长文可用性提升（20 万字阈值）。
- **标点修复 (Correction)**：英文直引号等混排边界修复更靠谱，减少手工返工。
- **稳定性 (Stability)**：修复流程加入异常隔离 + 预算限额 + 防重入，避免 Typora 被脚本拖崩。

### 3.2 启示（建议长期遵循）
- 在宿主应用里做脚本增强，本质是“在别人的进程里做手术”：稳定性与自我约束永远第一优先级。
- 高风险能力必须预算化：可控（限量/限时）、可降级（跳过极端输入）、可重复（多次点击渐进完成）。

---

## 5. 新式武器：修复预算两档配置 (Calibration of Firepower)

> "文火慢炖还是猛火爆炒？现在你有选择了。"

### 4.1 使用方式
- 体检面板底部新增一个按钮：显示“稳”或“狠”。
- 点击即可在两档间切换；模式会写入 localStorage，下次打开仍保持上次选择。

### 4.2 两档含义与参数（当前默认值）

| 档位 | 标签 | minIntervalMs | maxNodesPerFix | maxMs | maxTextChars | 适用场景 |
|---|---:|---:|---:|---:|---:|---|
| **稳** | **稳** | 250 | 600 | 250 | 50000 | 优先不崩溃、避免卡顿；对极端文本更保守 (Safety First) |
| **狠** | **狠** | 80 | 1800 | 800 | 120000 | 追求单次修得更多；文档大但机器也更强时使用 (Max Thrust) |

**参数解释：**
- `minIntervalMs`：两次修复最短间隔，防连点重入与短时频繁触发。
- `maxNodesPerFix`：单次最多处理的问题节点数（越大越“狠”，但更容易卡顿/触发边界）。
- `maxMs`：单次修复的时间预算，超时就停止本轮修复。
- `maxTextChars`：单个文本节点（段落片段）超过该长度则跳过，避免对超长段落做重操作。

### 4.3 如何调整
- 如果你想更“狠”：优先提高 `maxMs`、`maxNodesPerFix`，其次再降 `minIntervalMs`。
- 如果你想更“稳”：优先降低 `maxNodesPerFix`、`maxMs`，并提高 `minIntervalMs`。
